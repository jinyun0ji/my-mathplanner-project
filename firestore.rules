rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /* ---------- Helpers ---------- */
    function isSignedIn() {
      return request.auth != null;
    }

    function userDoc() {
      return isSignedIn()
        ? get(/databases/$(database)/documents/users/$(request.auth.uid))
        : null;
    }

    function userRole() {
      return userDoc() != null ? userDoc().data.role : null;
    }

    function isAdmin() {
      return userRole() == 'admin';
    }

    function isStaff() {
      return userRole() == 'staff';
    }

    function isStaffOrAdmin() {
      return isAdmin() || isStaff();
    }

    function isStudent() {
      return userRole() == 'student';
    }

    function isParent() {
      return userRole() == 'parent';
    }

    function parentStudentIds() {
      return isParent() && userDoc().data.studentIds != null
        ? userDoc().data.studentIds
        : [];
    }

    function canViewStudent(studentId) {
      return isStaffOrAdmin()
        || (isStudent() && request.auth.uid == studentId)
        || (isParent() && parentStudentIds().hasAny([studentId]));
    }

    /* ---------- users (⚠️ 중요) ---------- */
    match /users/{uid} {
      // 본인 문서만 읽기 (단건)
      allow get, read: if isSignedIn() && request.auth.uid == uid;

      // 관리자만 수정
      allow write: if isAdmin();

      // list 절대 금지
      allow list: if false;
    }

    /* ---------- students ---------- */
    match /students/{id} {
      allow get: if isSignedIn() && canViewStudent(id);
      allow list: if isStaffOrAdmin();
      allow write: if isAdmin();
    }

    /* ---------- attendances ---------- */
    match /attendances/{id} {
      allow read, list: if isStaffOrAdmin();
      allow write: if isStaffOrAdmin();
    }

    /* ---------- homeworks ---------- */
    match /homeworks/{id} {
      allow read, list: if isStaffOrAdmin();
      allow write: if isStaffOrAdmin();
    }

    /* ---------- grades ---------- */
    match /grades/{id} {
      allow read, list: if isStaffOrAdmin();
      allow write: if isStaffOrAdmin();
    }

    /* ---------- memos ---------- */
    match /memos/{id} {
      allow read, list: if isStaffOrAdmin();
      allow write: if isStaffOrAdmin();
    }

    /* ---------- default deny ---------- */
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

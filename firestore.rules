rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() { return request.auth != null; }
    function signedIn() { return isSignedIn(); }
    function uid() { return request.auth.uid; }
    function isSelf(targetUid) { return isSignedIn() && uid() == targetUid; }

    /** ✅ B안: authUid -> userDocId/role 인덱스 */
    function authIndex() {
      return isSignedIn() && exists(/databases/$(database)/documents/userAuthIndex/$(uid()))
        ? get(/databases/$(database)/documents/userAuthIndex/$(uid()))
        : null;
    }

    /** ✅ 내 프로필 문서ID: 인덱스 있으면 userDocId, 없으면 기존 uid */
    function myProfileDocId() {
      return authIndex() != null
        ? authIndex().data.userDocId
        : uid();
    }

    /** ✅ 내 역할: 인덱스 role 우선, 없으면 기존 users/{uid}.role */
    function userRole() {
      return authIndex() != null
        ? authIndex().data.role
        : (exists(/databases/$(database)/documents/users/$(uid()))
            ? get(/databases/$(database)/documents/users/$(uid())).data.role
            : null);
    }

    /** ✅ 내 프로필 문서: users/{myProfileDocId()} */
    function userDoc() {
      return isSignedIn() && exists(/databases/$(database)/documents/users/$(myProfileDocId()))
        ? get(/databases/$(database)/documents/users/$(myProfileDocId()))
        : null;
    }

    function resourceRole() { return resource != null ? resource.data.role : null; }
    function requestRole() { return request.resource.data.role; }
    function isResourceRole(role) { return resourceRole() == role; }
    function isRequestRole(role) { return requestRole() == role; }

    function isAdminOrStaff() { return userRole() in ['admin', 'staff', 'teaching', 'staffOrTeaching', 'teacher']; }
    function isAdmin() { return userRole() == 'admin'; }
    function isStaff() { return userRole() == 'staff'; }
    function isTeacher() { return userRole() in ['teacher', 'teaching', 'staffOrTeaching']; }
    function isStaffOrTeacher() { return isStaff() || isTeacher(); }
    function isStaffOrAdmin() { return isStaff() || isAdmin(); }
    function isStaffOrAdminOrTeacher() { return isAdminOrStaff(); }
    function isStudent() { return userRole() == 'student'; }
    function isParent() { return userRole() == 'parent'; }

    /** ✅ 학생이면: 내 학생 문서ID = myProfileDocId() */
    function getMyStudentId() {
      return isSignedIn() && isStudent() ? myProfileDocId() : null;
    }

    /** 부모의 연결 학생들 */
    function parentStudentUids() {
      return isParent() && userDoc() != null && userDoc().data.studentIds != null
        ? userDoc().data.studentIds
        : [];
    }

    function listContainsAny(list, candidates) {
      return (candidates.size() > 0 && candidates[0] in list)
        || (candidates.size() > 1 && candidates[1] in list)
        || (candidates.size() > 2 && candidates[2] in list)
        || (candidates.size() > 3 && candidates[3] in list)
        || (candidates.size() > 4 && candidates[4] in list);
    }

    /** ✅ 학생/부모 소속 판단: authUid / studentDocId 둘 다 인정 */
    function isMyStudentUid(value) {
      return isSignedIn() && (
        // 1) value가 authUid인 경우(기존)
        value == uid()

        // 2) value가 studentDocId인 경우: 그 users 문서의 authUid가 내 uid
        || (
          value is string
          && exists(/databases/$(database)/documents/users/$(value))
          && get(/databases/$(database)/documents/users/$(value)).data.authUid == uid()
        )

        // 3) 학생 본인 docId (B안)
        || (isStudent() && value == getMyStudentId())

        // 4) 부모의 studentIds
        || (isParent() && value in parentStudentUids())
      );
    }

    /** ✅ 클래스 멤버 체크: authUid / studentDocId / 부모 studentIds 대응 */
    function isClassMember(classId) {
      return isSignedIn()
        && classId is string
        && exists(/databases/$(database)/documents/classes/$(classId))
        && (
          // staff/admin은 별도로 처리하지만, 여기선 학생/부모용만
          (isStudent() && getMyStudentId() in get(/databases/$(database)/documents/classes/$(classId)).data.students)
          || (isParent() && listContainsAny(get(/databases/$(database)/documents/classes/$(classId)).data.students, parentStudentUids()))
          // (레거시) authUid 기반이 남아있을 경우도 허용
          || uid() in get(/databases/$(database)/documents/classes/$(classId)).data.students
          || (myStudentDocId() != null && myStudentDocId() in get(/databases/$(database)/documents/classes/$(classId)).data.students)
        );
    }

    function hasValidInvite(inviteId, role) {
      return inviteId is string
        && exists(/databases/$(database)/documents/invites/$(inviteId))
        && get(/databases/$(database)/documents/invites/$(inviteId)).data.consumed == false
        && get(/databases/$(database)/documents/invites/$(inviteId)).data.role == role
        && (
          get(/databases/$(database)/documents/invites/$(inviteId)).data.expiresAt == null
          || get(/databases/$(database)/documents/invites/$(inviteId)).data.expiresAt > request.time
        );
    }
    
    function pickStudentKey(data) {
      return (data != null && ('studentUid' in data)) ? data.studentUid
        : (data != null && ('studentId' in data)) ? data.studentId
        : (data != null && ('authUid' in data)) ? data.authUid
        : null;
    }

    function isMineByAnyKey(data) {
      return isMyStudentUid(pickStudentKey(data));
    }
    
    function isMyChild(userId) {
      return isParent()
        && userDoc() != null
        && userDoc().data.studentIds != null
        && userId in userDoc().data.studentIds;
    }
    
    function isMyChildDoc(userId) {
      return isParent() && (userId in parentStudentUids());
    }
    
    function myStudentDocId() {
      return isSignedIn()
        && exists(/databases/$(database)/documents/userAuthIndex/$(uid()))
        ? get(/databases/$(database)/documents/userAuthIndex/$(uid())).data.userDocId
        : null;
    }

    /* =========================
       users
    ========================= */
    match /users/{userId} {
      // ✅ 내 프로필 문서(users/{myProfileDocId}) get 가능
      allow get: if (signedIn() && userId == myProfileDocId()) 
      	|| isAdminOrStaff()
        || isMyChildDoc(userId);

      // list는 여전히 staff만 (보안 유지)
      allow list: if isStaffOrAdminOrTeacher();

      // ✅ 학생/부모/직원 모두: 자기 authUid가 박힌 문서는 read 허용
      allow read: if isStaffOrAdminOrTeacher()
        || (isSignedIn() && resource.data.authUid == uid())
        || isMyChildDoc(userId);

      allow create: if isStaffOrAdminOrTeacher()
        || (
          isSignedIn()
          && isSelf(userId)
          && request.resource.data.active == true
          && (isRequestRole('student') || isRequestRole('parent'))
          && hasValidInvite(request.resource.data.inviteId, request.resource.data.role)
        );

      allow update: if isStaffOrAdminOrTeacher()
        || (
          isSignedIn()
          && isSelf(userId)
          && (isResourceRole('student') || isResourceRole('parent'))
          && request.resource.data.role == resource.data.role
        )
        || (
          isSignedIn()
          && isResourceRole('student')
          && (resource.data.authUid == null || resource.data.authUid == '')
          && request.resource.data.authUid == uid()
          && request.resource.data.role == resource.data.role
          && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['authUid', 'email', 'hasAccount', 'updatedAt'])
        );

      allow delete: if isStaffOrAdminOrTeacher()
        || (signedIn() && uid() == userId);
    }

    // ✅ userAuthIndex 읽기 허용 유지
    match /userAuthIndex/{u} { allow read: if request.auth.uid == u; }

    /* =========================
       classes
    ========================= */
    match /classes/{docId} {
      allow get, read, list: if isAdminOrStaff()
        || (isSignedIn() && (
          // 학생: studentDocId 기준
          (isStudent() && getMyStudentId() in resource.data.students)
          // 부모: studentIds 기준
          || (isParent() && listContainsAny(resource.data.students, parentStudentUids()))
          // 레거시 authUid
          || (uid() in resource.data.students)
        ));
      allow write: if isAdminOrStaff();
    }

    /* =========================
       tests / lessonLogs / homeworkAssignments 등
       (여기는 기존대로 두되, isClassMember가 B안 대응되었기 때문에 대부분 살아남)
    ========================= */
    match /tests/{docId} {
      allow read, list: if isAdminOrStaff()
        || (isSignedIn() && isClassMember(resource.data.classId));
      allow write: if isAdminOrStaff();
    }
    
    match /classTestStats/{docId} {

      // docId: "{classId}_{testId}" 형태를 전제로 classId 파싱
      function statClassId() {
        return docId.split('_')[0];
      }

      allow get: if isAdminOrStaff()
        || (isSignedIn() && isClassMember(statClassId()));

      // 필요하면 나중에 list도 열 수 있지만 지금은 안전하게 유지
      allow list: if false;

      // write는 (직원 앱이 쓰는 경우만) 허용. Cloud Functions(Admin SDK)은 rules 무시함.
      allow write: if isStaffOrAdminOrTeacher();
    }

    match /lessonLogs/{docId} {
      allow read, list: if isAdminOrStaff()
        || (isSignedIn() && isClassMember(resource.data.classId));
      allow write: if isStaffOrAdminOrTeacher();
    }

    match /attendanceLogs/{docId} {
      allow read, list: if isStaffOrAdminOrTeacher()
        || (isSignedIn() && isMineByAnyKey(resource.data));
      allow write: if isStaffOrAdminOrTeacher();
    }

    match /clinicLogs/{docId} {
      allow get, read, list: if isStaffOrAdminOrTeacher()
        || (isSignedIn() 
        	&& (
            // 새 구조: authUid 필드가 학생 authUid 또는 studentDocId일 수 있음
            ('authUid' in resource.data && isMyStudentUid(resource.data.authUid))
            // 혹시 studentId로 저장된 문서도 커버
            || ('studentId' in resource.data && isMyStudentUid(resource.data.studentId))
            // 혹시 studentUid 필드가 남아있는 문서도 커버
            || ('studentUid' in resource.data && isMyStudentUid(resource.data.studentUid))
          )
        );
      allow write: if isStaffOrAdminOrTeacher();
    }

    match /workLogs/{docId} {
      allow read, list: if isStaffOrAdminOrTeacher();
      allow write: if isStaffOrAdminOrTeacher();
    }

    match /announcements/{docId} {
      allow read: if isAdminOrStaff()
        || (isSignedIn()
          && (
            (!('targetStudents' in resource.data) || resource.data.targetStudents.size() == 0)
              ? (!('classId' in resource.data) || isClassMember(resource.data.classId))
              : (uid() in resource.data.targetStudents || getMyStudentId() in resource.data.targetStudents || (isParent() && listContainsAny(resource.data.targetStudents, parentStudentUids())))
          ));
      allow write: if isStaffOrAdminOrTeacher();
    }

    match /homeworkAssignments/{docId} {
      allow read: if isAdminOrStaff()
        || (isSignedIn() && isClassMember(resource.data.classId));
      allow write: if isStaffOrAdminOrTeacher();
    }

    match /materials/{docId} {
      allow read, list: if isStaffOrAdminOrTeacher();
      allow create, update, delete: if isStaffOrAdminOrTeacher();
    }

    match /books/{docId} {
      allow read, list: if isStaffOrAdminOrTeacher();
      allow create, update, delete: if isStaffOrAdminOrTeacher();
    }

    match /payments/{docId} {
      allow read, write, list: if isStaffOrAdminOrTeacher();
      allow create, update, delete: if isStaffOrAdminOrTeacher();
    }

    match /grades/{docId} {
      allow read, list: if isStaffOrAdminOrTeacher()
        || (isSignedIn() && isMineByAnyKey(resource.data));
      allow write: if isStaffOrAdminOrTeacher();
    }

    match /homeworkResults/{docId} {
      allow read, list: if isStaffOrAdminOrTeacher()
        || (isSignedIn() && isMineByAnyKey(resource.data));
      allow write: if isStaffOrAdminOrTeacher();
    }

    match /videoProgress/{docId} {
      allow read, list: if isSignedIn() && isMineByAnyKey(resource.data);
      allow write: if isSignedIn() && isMyStudentUid(pickStudentKey(request.resource.data));
    }
    
    match /videoMemos/{uid}/items/{memoId} {
      allow read: if request.auth != null && request.auth.uid == uid;
      allow create, update, delete: if request.auth != null && request.auth.uid == uid;
    }

    match /externalSchedules/{docId} {
      allow read, list: if isStaffOrAdminOrTeacher()
        || (
          isSignedIn()
          && (
            // 기존(authUid 기반)도 살려두기
            (resource.data.authUid is string && isMyStudentUid(resource.data.authUid))
            // ✅ 새 구조(studentId 기반)도 허용
            || (resource.data.studentId is string && isMyStudentUid(resource.data.studentId))
          )
        );

      // ✅ write도 동일 기준
      allow write: if isStaffOrAdminOrTeacher()
        || (
          isSignedIn()
          && (
            (request.resource.data.authUid is string && isMyStudentUid(request.resource.data.authUid))
            || (request.resource.data.studentId is string && isMyStudentUid(request.resource.data.studentId))
          )
        );
    }

    match /invites/{inviteId} {
      allow get: if signedIn();
      allow list: if isStaffOrAdminOrTeacher();
      allow create, delete: if isStaffOrAdminOrTeacher();
      allow update: if isStaffOrAdminOrTeacher()
        || (
          signedIn()
          && resource.data.consumed == false
          && request.resource.data.consumed == true
          && request.resource.data.consumedByAuthUid == uid()
          && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['consumed', 'consumedByAuthUid', 'consumedAt'])
        );
    }

    match /accountLinks/{authUid} {
      allow get: if request.auth != null && request.auth.uid == authUid;
      allow list: if false;
      allow create, update, delete: if false;
    }

    match /notifications/{logId} {
      allow read, write: if isStaffOrAdminOrTeacher();
    }

    match /notifications/{userUid}/items/{notificationId} {
      allow read: if signedIn()
        && (uid() == userUid || isStaffOrAdminOrTeacher());

      // ✅ 본인: 읽음 처리용 update만 허용
      allow update: if signedIn()
        && uid() == userUid
        && request.resource.data.diff(resource.data).changedKeys()
            .hasOnly(['isRead', 'readAt', 'updatedAt']);

      // ✅ 직원/관리자/강사: 기존대로 full 권한
      allow create, update, delete: if isStaffOrAdminOrTeacher();
    }

    match /notifications/{userUid}/meta {
      allow read, write: if signedIn()
        && (uid() == userUid || isStaffOrAdminOrTeacher());
    }
    
    match /notifications/{userUid}/meta/{metaId} {
      allow read, write: if signedIn()
        && (uid() == userUid || isStaffOrAdminOrTeacher());
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}